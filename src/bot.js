/**
 * @file src/bot.js
 * @description –¢–æ—á–∫–∞ —Å–±–æ—Ä–∫–∏ –ª–æ–≥–∏–∫–∏ –±–æ—Ç–∞ (Controller).
 * –ü–æ–¥–∫–ª—é—á–∞–µ—Ç –≤—Å–µ –º–æ–¥—É–ª–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ.
 * @module BotController
 */

import { bot } from './core.js'; 
import { setupAuthHandlers } from './handlers/auth.js';
import { setupAdminHandlers } from './handlers/admin.js'; // üî• –í–ê–ñ–ù–û: –ù–æ–≤—ã–π –º–æ–¥—É–ª—å –∞–¥–º–∏–Ω–∫–∏
import { setupMessageHandlers } from './handlers/messages.js';
import { setupCallbackHandlers } from './handlers/callbacks.js';

/**
 * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏–∫–∏ –±–æ—Ç–∞.
 * –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –≤–µ–±—Ö—É–∫–∏ –∏ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç —Ä–æ—É—Ç–µ—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π.
 */
export const initBot = async () => {
    console.log('ü§ñ [BOT] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤...');

    // 1. –°–±—Ä–æ—Å –≤–µ–±—Ö—É–∫–æ–≤ (Critical for Polling)
    // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ try/catch, —á—Ç–æ–±—ã —Å—Ç–∞—Ä—Ç –Ω–µ –ø–∞–¥–∞–ª –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º —Å–µ—Ç–∏
    try {
        await bot.deleteWebHook();
        console.log('üßπ [BOT] –í–µ–±—Ö—É–∫–∏ –æ—á–∏—â–µ–Ω—ã (—Ä–µ–∂–∏–º Polling –∞–∫—Ç–∏–≤–µ–Ω).');
    } catch (e) {
        console.warn('‚ö†Ô∏è [BOT WARNING] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–±—Ä–æ—Å–∏—Ç—å –≤–µ–±—Ö—É–∫ (–≤–æ–∑–º–æ–∂–Ω–æ, —É–∂–µ —É–¥–∞–ª–µ–Ω):', e.message);
    }

    // 2. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª–µ–π (–ü–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω!)
    // –°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∞–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã (–ê–¥–º–∏–Ω–∫–∞, –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è), 
    // —á—Ç–æ–±—ã –æ–±—â–∏–µ (Messages) –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏–ª–∏ –∏—Ö –∫–æ–º–∞–Ω–¥—ã.
    
    setupAuthHandlers();      // üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏
    setupAdminHandlers();     // üëë –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (KPI, –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏, –î–µ–Ω—å–≥–∏)
    setupCallbackHandlers();  // üñ± –ù–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–æ–∫ (Inline)
    setupMessageHandlers();   // üí¨ –û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç –∏ –º–µ–Ω—é (Wizard)

    // 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Å—Ç–æ–≤ –≤ –∫–∞–Ω–∞–ª–∞—Ö
    // –ï—Å–ª–∏ –±–æ—Ç –∞–¥–º–∏–Ω –≤ –∫–∞–Ω–∞–ª–µ, –æ–Ω –±—É–¥–µ—Ç –≤–∏–¥–µ—Ç—å –ø–æ—Å—Ç—ã –∫–∞–∫ –æ–±—ã—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    bot.on('channel_post', (msg) => {
        // –≠–º–∏—Ç–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ 'message', —á—Ç–æ–±—ã —Ö–µ–Ω–¥–ª–µ—Ä—ã –º–æ–≥–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã –∏–∑ –∫–∞–Ω–∞–ª–æ–≤
        bot.emit('message', msg);
    });

    console.log('‚úÖ [BOT] –í—Å–µ –º–æ–¥—É–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –°–∏—Å—Ç–µ–º–∞ –æ–Ω–ª–∞–π–Ω!');
};