/**
 * @file src/server.js
 * @description –ì–ª–∞–≤–Ω—ã–π –∑–∞–≥—Ä—É–∑—á–∏–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ (Service Bootstrapper v10.0.0).
 * –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞:
 * 1. –°—Ç—Ä–æ–≥—É—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å–∫–∞: –ë–î -> Web Server -> WebSockets -> Telegram Bot.
 * 2. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –∏ —Å–∏–¥–∏–Ω–≥–∞ (initDB).
 * 3. –ù–∞—Å—Ç—Ä–æ–π–∫—É Graceful Shutdown (–±–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö).
 * 4. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é Socket.IO –¥–ª—è Real-Time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π ERP.
 *
 * @module Server
 * @version 10.0.0 (Enterprise ERP Edition)
 * @author ProElectric Team
 */

import { Server as SocketIOServer } from "socket.io"; // NEW: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è WebSockets
import app from "./app.js";
import { bot, setSocketIO } from "./bot.js"; // UPDATED: –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–µ—Ç—Ç–µ—Ä –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ io –≤ –±–æ—Ç–∞
import { initDB, closePool } from "./database/index.js";
import { config } from "./config.js";

const PORT = config.server.port || 3000;

/**
 * üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤ —Å–∏—Å—Ç–µ–º—ã.
 * –ü–æ—Ä—è–¥–æ–∫ —Å—Ç—Ä–æ–≥–æ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω: —Å–Ω–∞—á–∞–ª–∞ –±–∞–∑–∞, –ø–æ—Ç–æ–º API, –ø–æ—Ç–æ–º –°–æ–∫–µ—Ç—ã, –ø–æ—Ç–æ–º –ë–æ—Ç.
 */
async function startServer() {
  try {
    // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (DDL + Seeding)
    console.log(
      "üóÑ [Server] –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —è–¥—Ä–∞ ERP...",
    );
    await initDB();
    console.log("‚úÖ [Server] –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞.");

    // 2. –ó–∞–ø—É—Å–∫ Express REST API —Å–µ—Ä–≤–µ—Ä–∞ (Web CRM)
    const server = app.listen(PORT, () => {
      console.log(`üåê [Server] Web CRM & REST API –∑–∞–ø—É—â–µ–Ω—ã –Ω–∞ –ø–æ—Ä—Ç—É: ${PORT}`);
      console.log(`üîó [Server] –õ–æ–∫–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø: http://localhost:${PORT}`);
    });

    // =========================================================================
    // 2.5 –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø WEBSOCKETS (NEW)
    // =========================================================================
    console.log("üîå [Server] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebSocket-—Å–µ—Ä–≤–µ—Ä–∞ (Socket.IO)...");
    const io = new SocketIOServer(server, {
      cors: {
        origin: config.server.corsOrigin || "*",
        methods: ["GET", "POST", "PATCH", "PUT", "DELETE"],
        credentials: true,
      },
    });

    // –ü–µ—Ä–µ–¥–∞–µ–º –∏–Ω—Å—Ç–∞–Ω—Å —Å–æ–∫–µ—Ç–æ–≤ –≤ Telegram-–±–æ—Ç (—á—Ç–æ–±—ã –±–æ—Ç –º–æ–≥ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å emit'—ã)
    setSocketIO(io);

    // –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
    io.on("connection", (socket) => {
      console.log(`‚ö°Ô∏è [WebSocket] –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω: ${socket.id}`);

      socket.on("disconnect", () => {
        console.log(`üîå [WebSocket] –ö–ª–∏–µ–Ω—Ç –æ—Ç–∫–ª—é—á–µ–Ω: ${socket.id}`);
      });
    });
    console.log("‚úÖ [Server] WebSockets —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ —Å–µ—Ä–≤–µ—Ä—É.");

    // 3. –ó–∞–ø—É—Å–∫ Telegram –ë–æ—Ç–∞ (Long-polling)
    console.log("ü§ñ [Server] –ó–∞–ø—É—Å–∫ Telegram-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ (ProElectric Bot)...");
    await bot.launch();
    console.log(
      `‚úÖ [Server] Telegram-–±–æ—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ API –∏ —Å–ª—É—à–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.`,
    );

    // =========================================================================
    // üõ° GRACEFUL SHUTDOWN (–ë–ï–ó–û–ü–ê–°–ù–ê–Ø –û–°–¢–ê–ù–û–í–ö–ê)
    // =========================================================================
    // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ç PM2 –∏–ª–∏ Docker),
    // —á—Ç–æ–±—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∏ –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã.

    const gracefulShutdown = async (signal) => {
      console.log(
        `\nüõë [Shutdown] –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª ${signal}. –ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º—ã...`,
      );

      try {
        // 1. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏–µ–º –Ω–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç Telegram
        console.log("‚è≥ [Shutdown] –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Telegram-–±–æ—Ç–∞...");
        bot.stop(signal);

        // 2. –ó–∞–∫—Ä—ã–≤–∞–µ–º HTTP-—Å–µ—Ä–≤–µ—Ä Express –∏ WebSockets
        console.log(
          "‚è≥ [Shutdown] –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã Web-—Å–µ—Ä–≤–µ—Ä–∞ –∏ WebSockets...",
        );
        server.close(async () => {
          console.log("‚úÖ [Shutdown] Web-—Å–µ—Ä–≤–µ—Ä —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.");

          // 3. –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å PostgreSQL
          console.log(
            "‚è≥ [Shutdown] –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö...",
          );
          await closePool();
          console.log("‚úÖ [Shutdown] –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î –∑–∞–∫—Ä—ã—Ç—ã.");

          console.log(
            "üëã [Shutdown] –°–∏—Å—Ç–µ–º–∞ ProElectric ERP v10.0.0 –±–µ–∑–æ–ø–∞—Å–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª–∞ —Ä–∞–±–æ—Ç—É.",
          );
          process.exit(0);
        });
      } catch (error) {
        console.error(
          "‚ùå [Shutdown] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Å–µ—Ä–≤–∏—Å–æ–≤:",
          error,
        );
        process.exit(1);
      }
    };

    // –°–ª—É—à–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
    process.once("SIGINT", () => gracefulShutdown("SIGINT")); // Ctrl+C –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
    process.once("SIGTERM", () => gracefulShutdown("SIGTERM")); // –°–∏–≥–Ω–∞–ª –æ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (Docker/PM2)
  } catch (error) {
    console.error("üí• [Server] –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ó–ê–ü–£–°–ö–ê –°–ò–°–¢–ï–ú–´:");
    console.error(error);
    process.exit(1); // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —É–±–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å, –µ—Å–ª–∏ —è–¥—Ä–æ –Ω–µ —Å–º–æ–≥–ª–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è
  }
}

// üèÅ –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
startServer();
