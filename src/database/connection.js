/**
 * @file src/database/connection.js
 * @description –ú–æ–¥—É–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏ —Å PostgreSQL.
 * –†–µ–∞–ª–∏–∑—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω "Connection Pool" –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π.
 * @module DatabaseConnection
 * @version 1.0.0 (Senior Level)
 */

import pg from "pg";
import { config } from "../config.js"; // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω—Ñ–∏–≥–∞

// –î–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã –∫–æ–¥–∞
const { Pool } = pg;

// =============================================================================
// –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ü–£–õ–ê (POOL CONFIGURATION)
// =============================================================================
const poolConfig = {
  host: config.db.host,
  port: config.db.port,
  user: config.db.user,
  password: config.db.password,
  database: config.db.database,

  // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ –ø—É–ª–µ.
  // –ó–Ω–∞—á–µ–Ω–∏–µ 20 –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å—Ä–µ–¥–Ω–∏—Ö –Ω–∞–≥—Ä—É–∑–æ–∫.
  max: 20,

  // –í—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è –∫–ª–∏–µ–Ω—Ç–∞ (–≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö) –ø–µ—Ä–µ–¥ –µ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏–µ–º.
  idleTimeoutMillis: 30000,

  // –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è (–≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö) –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.
  connectionTimeoutMillis: 2000,
};

// –°–æ–∑–¥–∞–µ–º –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –ø—É–ª–∞ –Ω–∞ –≤—Å–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (Singleton)
const pool = new Pool(poolConfig);

// =============================================================================
// –ú–û–ù–ò–¢–û–†–ò–ù–ì –°–û–°–¢–û–Ø–ù–ò–Ø (POOL EVENTS)
// =============================================================================

// –°–æ–±—ã—Ç–∏–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–∞–∂–¥–æ–≥–æ –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –≤ –ø—É–ª–µ
pool.on("connect", () => {
  // –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫—É –¥–ª—è Grafana/Prometheus
  // console.log("üì¶ [DB POOL] –°–æ–∑–¥–∞–Ω–æ –Ω–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö.");
});

// –°–æ–±—ã—Ç–∏–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
pool.on("error", (err) => {
  console.error(
    "üî• [DB POOL ERROR] –í–Ω–µ–∑–∞–ø–Ω–∞—è –æ—à–∏–±–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:",
    err,
  );
  // –ù–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –Ω–µ –ø–æ–ª–æ–∂–∏—Ç—å –≤—Å—ë –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ,
  // –ø—É–ª —Å–∞–º –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.
});

// =============================================================================
// –ü–£–ë–õ–ò–ß–ù–´–ï –ú–ï–¢–û–î–´ (PUBLIC METHODS)
// =============================================================================

/**
 * –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ –ø—É–ª–∞ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.
 * ‚ö†Ô∏è –í–ê–ñ–ù–û: –ü–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –Ω—É–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å client.release(),
 * –∏–Ω–∞—á–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–≤–∏—Å–Ω–µ—Ç –∏ –ø—É–ª –ø–µ—Ä–µ–ø–æ–ª–Ω–∏—Ç—Å—è.
 *
 * @returns {Promise<import('pg').PoolClient>} –ö–ª–∏–µ–Ω—Ç PostgreSQL
 */
export const getClient = async () => {
  try {
    const client = await pool.connect();
    return client;
  } catch (error) {
    console.error("‚ùå [DB CONNECTION] –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ –ø—É–ª–∞.");
    throw error;
  }
};

/**
 * –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ SQL-–∑–∞–ø—Ä–æ—Å–∞ (Shortcut).
 * –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±–µ—Ä–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞, –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –≤ –ø—É–ª.
 * –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –±–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.
 *
 * @param {string} text - SQL-–∑–∞–ø—Ä–æ—Å
 * @param {Array<any>} params - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞
 * @returns {Promise<import('pg').QueryResult>} –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞
 */
export const query = async (text, params) => {
  const start = Date.now();
  try {
    const res = await pool.query(text, params);

    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–æ–ª—å—à–µ 100–º—Å)
    const duration = Date.now() - start;
    if (duration > 100) {
      console.warn(`‚ö†Ô∏è [DB SLOW QUERY] –ó–∞–ø—Ä–æ—Å –∑–∞–Ω—è–ª ${duration}–º—Å: ${text}`);
    }

    return res;
  } catch (error) {
    console.error("‚ùå [DB QUERY ERROR] –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞:", {
      text,
      error,
    });
    throw error;
  }
};

/**
 * –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π.
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ Graceful Shutdown (–æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Å–µ—Ä–≤–µ—Ä–∞).
 */
export const closePool = async () => {
  await pool.end();
  console.log("üîå [DB POOL] –ü—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∑–∞–∫—Ä—ã—Ç.");
};
