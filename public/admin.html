import { initDB } from './src/db.js';
import { initBot } from './src/bot.js';
import { startServer } from './src/server.js';

// --- Ð“Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¿ÐµÑ€ÐµÑ…Ð²Ð°Ñ‚Ñ‡Ð¸ÐºÐ¸ Ð¾ÑˆÐ¸Ð±Ð¾Ðº (Safety Net) ---
// Ð•ÑÐ»Ð¸ Ð³Ð´Ðµ-Ñ‚Ð¾ Ð² ÐºÐ¾Ð´Ðµ Ð·Ð°Ð±Ñ‹Ð»Ð¸ try-catch, ÑÑ‚Ð¾ ÑÐ¿Ð°ÑÐµÑ‚ Ð»Ð¾Ð³Ð¸ Ð¾Ñ‚ Ð¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸Ñ
process.on('unhandledRejection', (reason, promise) => {
    console.error('ðŸ”¥ [FATAL] ÐÐµÐ¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ° (Promise):', reason);
    // Ð’ Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐµÐ½Ðµ Ð»ÑƒÑ‡ÑˆÐµ Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ, Ñ‡ÐµÐ¼ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ Ð² ÑÐ»Ð¾Ð¼Ð°Ð½Ð½Ð¾Ð¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¸
    // process.exit(1);
});

process.on('uncaughtException', (error) => {
    console.error('ðŸ”¥ [FATAL] ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ°:', error);
    process.exit(1);
});

/**
 * Ð“Ð»Ð°Ð²Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
 */
async function bootstrap() {
    console.log('ðŸ”Œ ProElectro System: Ð—Ð°Ð¿ÑƒÑÐº ÑÐ¸ÑÑ‚ÐµÐ¼...');

    try {
        // Ð­Ð¢ÐÐŸ 1: ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð‘Ð°Ð·Ðµ Ð”Ð°Ð½Ð½Ñ‹Ñ…
        // ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð²Ð°Ð¶Ð½Ð¾: Ð¶Ð´ÐµÐ¼ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ð¿ÐµÑ€ÐµÐ´ ÑÑ‚Ð°Ñ€Ñ‚Ð¾Ð¼ Ð²ÑÐµÐ³Ð¾ Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾
        await initDB();

        // Ð­Ð¢ÐÐŸ 2: Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð‘Ð¾Ñ‚Ð°
        // Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐ»ÑƒÑˆÐ°Ñ‚ÐµÐ»Ñ Telegram (Polling)
        initBot();

        // Ð­Ð¢ÐÐŸ 3: Ð—Ð°Ð¿ÑƒÑÐº Ð’ÐµÐ±-ÑÐµÑ€Ð²ÐµÑ€Ð°
        // Ð§Ñ‚Ð¾Ð±Ñ‹ Docker/Portainer Ð²Ð¸Ð´ÐµÐ»Ð¸, Ñ‡Ñ‚Ð¾ Ð¼Ñ‹ Ð¶Ð¸Ð²Ñ‹ (Healthcheck)
        startServer();

        console.log('âœ… [SYSTEM] Ð’ÑÐµ Ð¼Ð¾Ð´ÑƒÐ»Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ñ‹. Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð³Ð¾Ñ‚Ð¾Ð²Ð° Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ðµ.');

    } catch (error) {
        console.error('ðŸ’¥ [SYSTEM FATAL] ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐµ:', error);
        process.exit(1); // Ð’Ñ‹Ñ…Ð¾Ð´ Ñ ÐºÐ¾Ð´Ð¾Ð¼ Ð¾ÑˆÐ¸Ð±ÐºÐ¸, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Docker Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð» ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€
    }
}

// Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼
bootstrap();

// --- Graceful Shutdown (ÐœÑÐ³ÐºÐ¾Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ðµ) ---
// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÑÐ¸Ð³Ð½Ð°Ð»Ð¾Ð² Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð¾Ñ‚ Docker Ð¸Ð»Ð¸ Ctrl+C
const shutdown = (signal) => {
    console.log(`\nðŸ›‘ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½ ÑÐ¸Ð³Ð½Ð°Ð» ${signal}. Ð—Ð°Ð²ÐµÑ€ÑˆÐ°ÐµÐ¼ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ...`);
    // Ð—Ð´ÐµÑÑŒ Ð¼Ð¾Ð¶Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ð¿ÑƒÐ»Ð° Ð‘Ð”: await db.end();
    console.log('ðŸ‘‹ Ð”Ð¾ ÑÐ²Ð¸Ð´Ð°Ð½Ð¸Ñ!');
    process.exit(0);
};

process.on('SIGTERM', () => shutdown('SIGTERM'));
process.on('SIGINT', () => shutdown('SIGINT'));