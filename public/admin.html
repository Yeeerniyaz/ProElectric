<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ProElectric ERP | v9.1 Enterprise</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="/css/style.css" />

    <script src="https://unpkg.com/feather-icons"></script>
  </head>
  <body class="pe-theme-dark">
    <div id="loginView" class="view-section active pe-auth-screen">
      <div class="pe-auth-card">
        <div class="pe-auth-logo">
          <div class="pe-logo-icon"><i data-feather="zap"></i></div>
          <h2>
            ProElectric <span class="pe-badge pe-badge-primary">ERP</span>
          </h2>
          <p class="pe-text-muted">Enterprise Management System v9.1</p>
        </div>

        <form id="loginForm" class="pe-form">
          <div class="pe-form-group">
            <label>Логин системы</label>
            <div class="pe-input-group">
              <i data-feather="user" class="pe-input-icon"></i>
              <input
                type="text"
                id="adminLogin"
                required
                placeholder="Введите логин"
                class="pe-input"
              />
            </div>
          </div>
          <div class="pe-form-group">
            <label>Ключ доступа</label>
            <div class="pe-input-group">
              <i data-feather="lock" class="pe-input-icon"></i>
              <input
                type="password"
                id="adminPassword"
                required
                placeholder="••••••••"
                class="pe-input"
              />
            </div>
          </div>
          <button
            type="submit"
            class="pe-btn pe-btn-primary pe-btn-block pe-mt-4"
          >
            Авторизация <i data-feather="arrow-right"></i>
          </button>
        </form>
        <div
          id="loginError"
          class="pe-alert pe-alert-danger pe-mt-4"
          style="display: none"
        ></div>
      </div>
      <div class="pe-auth-bg-glow"></div>
    </div>

    <div id="appLayout" class="pe-app-layout" style="display: none">
      <aside class="pe-sidebar">
        <div class="pe-sidebar-header">
          <div class="pe-logo-icon pe-icon-sm"><i data-feather="zap"></i></div>
          <h3 class="pe-brand-text">ProElectric</h3>
        </div>

        <nav class="pe-sidebar-nav">
          <div class="pe-nav-section">Главное меню</div>
          <button
            class="nav-btn pe-nav-item active"
            data-target="dashboardView"
          >
            <i data-feather="grid"></i> <span>Аналитика</span>
          </button>
          <button class="nav-btn pe-nav-item" data-target="ordersView">
            <i data-feather="briefcase"></i> <span>Объекты</span>
          </button>

          <div class="pe-nav-section pe-mt-4">Управление</div>
          <button class="nav-btn pe-nav-item" data-target="settingsView">
            <i data-feather="sliders"></i> <span>Прайс-лист</span>
          </button>
          <button class="nav-btn pe-nav-item" data-target="usersView">
            <i data-feather="users"></i> <span>Персонал</span>
          </button>
          <button class="nav-btn pe-nav-item" data-target="broadcastView">
            <i data-feather="radio"></i> <span>Рассылка</span>
          </button>
        </nav>

        <div class="pe-sidebar-footer">
          <div class="pe-user-profile">
            <div class="pe-avatar"><i data-feather="shield"></i></div>
            <div class="pe-user-info">
              <span class="pe-user-name">Ернияз</span>
              <span class="pe-user-role">Owner / Architect</span>
            </div>
          </div>
          <button
            id="logoutBtn"
            class="pe-btn pe-btn-icon pe-btn-ghost"
            title="Выход"
          >
            <i data-feather="log-out"></i>
          </button>
        </div>
      </aside>

      <div class="pe-main-wrapper">
        <header class="pe-topbar">
          <div class="pe-topbar-left">
            <h2 class="pe-page-title" id="topbarTitle">Рабочая область</h2>
          </div>
          <div class="pe-topbar-right">
            <div class="pe-system-status">
              <span class="pe-status-dot"></span> Система online
            </div>
          </div>
        </header>

        <main class="pe-content">
          <section id="dashboardView" class="view-section pe-view">
            <div class="pe-section-header">
              <div>
                <h2 class="pe-h2">Финансовая сводка</h2>
                <p class="pe-text-muted">
                  Аналитика по всем объектам и воронка продаж
                </p>
              </div>
              <button class="pe-btn pe-btn-secondary" id="refreshStatsBtn">
                <i data-feather="refresh-cw"></i> Обновить данные
              </button>
            </div>

            <div class="pe-grid-kpi">
              <div class="pe-card pe-card-kpi pe-kpi-success">
                <div class="pe-kpi-icon">
                  <i data-feather="dollar-sign"></i>
                </div>
                <div class="pe-kpi-data">
                  <span class="pe-kpi-label">Чистая прибыль (Net Profit)</span>
                  <h3 id="statNetProfit" class="pe-kpi-value">0 ₸</h3>
                </div>
              </div>
              <div class="pe-card pe-card-kpi pe-kpi-primary">
                <div class="pe-kpi-icon">
                  <i data-feather="credit-card"></i>
                </div>
                <div class="pe-kpi-data">
                  <span class="pe-kpi-label">Оборот (Revenue)</span>
                  <h3 id="statRevenue" class="pe-kpi-value">0 ₸</h3>
                </div>
              </div>
              <div class="pe-card pe-card-kpi pe-kpi-warning">
                <div class="pe-kpi-icon"><i data-feather="activity"></i></div>
                <div class="pe-kpi-data">
                  <span class="pe-kpi-label">Объекты в работе</span>
                  <h3 id="statActiveOrders" class="pe-kpi-value">0</h3>
                </div>
              </div>
              <div class="pe-card pe-card-kpi pe-kpi-neutral">
                <div class="pe-kpi-icon"><i data-feather="users"></i></div>
                <div class="pe-kpi-data">
                  <span class="pe-kpi-label">Клиентская база</span>
                  <h3 id="statTotalUsers" class="pe-kpi-value">0</h3>
                </div>
              </div>
            </div>

            <div class="pe-card pe-mt-6">
              <div class="pe-card-header">
                <h3 class="pe-h3">Воронка лидов и объектов</h3>
              </div>
              <div class="pe-card-body">
                <div class="pe-funnel" id="funnelChart"></div>
              </div>
            </div>
          </section>

          <section
            id="ordersView"
            class="view-section pe-view"
            style="display: none"
          >
            <div class="pe-section-header">
              <div>
                <h2 class="pe-h2">Реестр объектов</h2>
                <p class="pe-text-muted">
                  Управление заказами, сметами и финансами
                </p>
              </div>
              <div class="pe-header-actions">
                <select
                  id="orderStatusFilter"
                  class="pe-input pe-select-inline"
                >
                  <option value="all">Все статусы</option>
                  <option value="new">Новые (Лиды)</option>
                  <option value="work">В работе</option>
                  <option value="done">Завершенные</option>
                </select>
                <button
                  class="pe-btn pe-btn-primary"
                  id="btnOpenManualOrderModal"
                >
                  <i data-feather="plus"></i> Создать оффлайн-заказ
                </button>
              </div>
            </div>

            <div class="pe-card pe-table-card">
              <div class="pe-table-responsive">
                <table class="pe-table">
                  <thead>
                    <tr>
                      <th>ID / Дата</th>
                      <th>Заказчик</th>
                      <th>Объект</th>
                      <th>Статус</th>
                      <th>Чистая Прибыль</th>
                      <th class="pe-text-right">Управление</th>
                    </tr>
                  </thead>
                  <tbody id="ordersTableBody"></tbody>
                </table>
              </div>
            </div>
          </section>

          <section
            id="settingsView"
            class="view-section pe-view"
            style="display: none"
          >
            <div class="pe-section-header">
              <div>
                <h2 class="pe-h2">Системный Прайс-лист</h2>
                <p class="pe-text-muted">
                  Глобальные расценки для генератора смет
                </p>
              </div>
              <button class="pe-btn pe-btn-success" id="btnSaveSettings">
                <i data-feather="save"></i> Сохранить изменения
              </button>
            </div>

            <div class="pe-card">
              <div class="pe-card-body">
                <div id="settingsFormContainer"></div>
              </div>
            </div>
          </section>

          <section
            id="usersView"
            class="view-section pe-view"
            style="display: none"
          >
            <div class="pe-section-header">
              <div>
                <h2 class="pe-h2">Доступы и Персонал</h2>
                <p class="pe-text-muted">Управление ролями в системе</p>
              </div>
            </div>
            <div class="pe-card pe-table-card">
              <div class="pe-table-responsive">
                <table class="pe-table">
                  <thead>
                    <tr>
                      <th>Telegram ID</th>
                      <th>Пользователь</th>
                      <th>Контакты</th>
                      <th>Уровень доступа</th>
                    </tr>
                  </thead>
                  <tbody id="usersTableBody"></tbody>
                </table>
              </div>
            </div>
          </section>

          <section
            id="broadcastView"
            class="view-section pe-view"
            style="display: none"
          >
            <div class="pe-section-header">
              <div>
                <h2 class="pe-h2">Центр уведомлений</h2>
                <p class="pe-text-muted">
                  Массовая рассылка через Telegram-бота
                </p>
              </div>
            </div>
            <div class="pe-card pe-max-w-md">
              <div class="pe-card-body pe-form">
                <div class="pe-form-group">
                  <label>Аудитория</label>
                  <select id="broadcastTarget" class="pe-input">
                    <option value="all">Всем (База полностью)</option>
                    <option value="user">Только клиентам</option>
                    <option value="manager">Персоналу (Мастера/Админы)</option>
                  </select>
                </div>
                <div class="pe-form-group">
                  <label>Текст сообщения (HTML/Markdown)</label>
                  <textarea
                    id="broadcastText"
                    class="pe-input pe-textarea"
                    rows="6"
                    placeholder="Введите текст рассылки..."
                  ></textarea>
                </div>
                <div class="pe-form-group">
                  <label>URL изображения (Необязательно)</label>
                  <input
                    type="text"
                    id="broadcastImage"
                    class="pe-input"
                    placeholder="https://example.com/promo.jpg"
                  />
                </div>
                <button
                  class="pe-btn pe-btn-primary pe-btn-block pe-mt-4"
                  id="btnSendBroadcast"
                >
                  <i data-feather="send"></i> Запустить кампанию
                </button>
              </div>
            </div>
          </section>
        </main>
      </div>
    </div>

    <div id="orderModal" class="pe-modal-overlay" style="display: none">
      <div class="pe-modal pe-modal-xl">
        <header class="pe-modal-header">
          <div class="pe-modal-title">
            <i data-feather="layers"></i>
            <h3 id="modalOrderTitle">Объект #...</h3>
          </div>
          <button class="pe-btn-close" id="btnCloseOrderModal">
            <i data-feather="x"></i>
          </button>
        </header>

        <div class="pe-modal-body">
          <div class="pe-grid-2col">
            <div class="pe-col-info">
              <div class="pe-info-card">
                <h4 class="pe-h4"><i data-feather="user"></i> Заказчик</h4>
                <div class="pe-info-row">
                  <span class="pe-text-muted">Имя:</span>
                  <strong id="modalClientName">...</strong>
                </div>
                <div class="pe-info-row">
                  <span class="pe-text-muted">Телефон:</span>
                  <strong id="modalClientPhone">...</strong>
                </div>
                <div class="pe-form-group pe-mt-4">
                  <label>Стадия объекта:</label>
                  <select id="modalOrderStatus" class="pe-input"></select>
                </div>
              </div>

              <div class="pe-info-card pe-mt-4">
                <h4 class="pe-h4">
                  <i data-feather="file-text"></i> Структура сметы
                </h4>
                <div id="modalEstimateDetails" class="pe-code-block"></div>
              </div>

              <div class="pe-info-card pe-mt-4">
                <h4 class="pe-h4">
                  <i data-feather="shopping-bag"></i> Спецификация (BOM)
                </h4>
                <div id="modalBOMList" class="pe-bom-container"></div>
              </div>
            </div>

            <div class="pe-col-finance">
              <div class="pe-finance-header">
                <h4 class="pe-h4">
                  <i data-feather="dollar-sign"></i> Финансовый контроллер
                </h4>
              </div>

              <div class="pe-finance-summary">
                <div class="pe-fin-row">
                  <span>Расчетная база сметы:</span>
                  <strong id="modalCalcPrice" class="pe-text-muted">0 ₸</strong>
                </div>
                <div class="pe-fin-row pe-fin-edit">
                  <span>Договорная цена клиенту:</span>
                  <div class="pe-input-group pe-input-group-sm">
                    <input
                      type="number"
                      id="modalFinalPrice"
                      class="pe-input"
                    />
                    <button
                      class="pe-btn pe-btn-primary"
                      id="btnUpdateFinalPrice"
                    >
                      <i data-feather="check"></i>
                    </button>
                  </div>
                </div>
                <div class="pe-fin-row">
                  <span>Сумма затрат (Чеки):</span>
                  <strong id="modalTotalExpenses" class="pe-text-danger"
                    >0 ₸</strong
                  >
                </div>
                <div class="pe-fin-divider"></div>
                <div class="pe-fin-row pe-fin-total">
                  <span>ЧИСТАЯ ПРИБЫЛЬ:</span>
                  <strong id="modalNetProfit" class="pe-text-success"
                    >0 ₸</strong
                  >
                </div>
              </div>

              <div class="pe-expenses-section pe-mt-6">
                <h5 class="pe-h5">Реестр расходов (Чеки)</h5>
                <div class="pe-expenses-list" id="modalExpensesList"></div>

                <div class="pe-expense-form pe-mt-4">
                  <h6 class="pe-h6 pe-mb-2">Списать новый расход</h6>
                  <div class="pe-form-group">
                    <input
                      type="number"
                      id="expenseAmount"
                      class="pe-input pe-input-sm"
                      placeholder="Сумма (₸)"
                    />
                  </div>
                  <div class="pe-form-group">
                    <select id="expenseCategory" class="pe-input pe-input-sm">
                      <option value="Материалы">Докупка материалов</option>
                      <option value="Транспорт">Логистика / Такси</option>
                      <option value="Инструмент">
                        Инструмент / Расходники
                      </option>
                      <option value="Прочее">Прочие расходы</option>
                    </select>
                  </div>
                  <div class="pe-form-group">
                    <input
                      type="text"
                      id="expenseComment"
                      class="pe-input pe-input-sm"
                      placeholder="Назначение (комментарий)"
                    />
                  </div>
                  <button
                    class="pe-btn pe-btn-danger pe-btn-block pe-btn-sm"
                    id="btnAddExpense"
                  >
                    <i data-feather="minus-circle"></i> Провести списание
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="manualOrderModal" class="pe-modal-overlay" style="display: none">
      <div class="pe-modal pe-modal-md">
        <header class="pe-modal-header">
          <div class="pe-modal-title">
            <i data-feather="plus-square"></i>
            <h3>Новый оффлайн-объект</h3>
          </div>
          <button class="pe-btn-close" id="btnCloseManualModal">
            <i data-feather="x"></i>
          </button>
        </header>
        <div class="pe-modal-body">
          <form id="formManualOrder" class="pe-form">
            <div class="pe-form-group">
              <label>ФИО Заказчика</label>
              <input
                type="text"
                id="manualName"
                class="pe-input"
                required
                placeholder="Иванов Иван"
              />
            </div>
            <div class="pe-form-group">
              <label>Контактный телефон</label>
              <input
                type="tel"
                id="manualPhone"
                class="pe-input"
                required
                placeholder="+7 (777) 000-00-00"
              />
            </div>
            <div class="pe-grid-2col-sm">
              <div class="pe-form-group">
                <label>Площадь (м²)</label>
                <input
                  type="number"
                  id="manualArea"
                  class="pe-input"
                  required
                  value="50"
                  min="10"
                />
              </div>
              <div class="pe-form-group">
                <label>Комнат</label>
                <input
                  type="number"
                  id="manualRooms"
                  class="pe-input"
                  required
                  value="2"
                  min="1"
                />
              </div>
            </div>
            <div class="pe-form-group">
              <label>Материал конструктива (Стены)</label>
              <select id="manualWallType" class="pe-input">
                <option value="wall_concrete">Бетон / Монолит</option>
                <option value="wall_brick">Кирпич</option>
                <option value="wall_gas">Газоблок / ГКЛ</option>
              </select>
            </div>
            <button
              type="submit"
              class="pe-btn pe-btn-success pe-btn-block pe-mt-4"
            >
              <i data-feather="cpu"></i> Сгенерировать расчет и создать
            </button>
          </form>
        </div>
      </div>
    </div>

    <div id="toastContainer" class="toast-container pe-toast-container"></div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        feather.replace();

        // Динамический заголовок Topbar
        document.querySelectorAll(".nav-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const text = e.currentTarget.querySelector("span").innerText;
            document.getElementById("topbarTitle").innerText = text;
          });
        });
      });
    </script>

    <script type="module" src="/js/app.js"></script>
  </body>
</html>
