<!DOCTYPE html>
<html lang="ru" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö°Ô∏è ProElectro Admin</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; }
        .card { background-color: #1e1e1e; border: 1px solid #333; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .navbar { background-color: #1e1e1e; border-bottom: 1px solid #333; }
        .btn-primary { background-color: #ff9800; border: none; color: #000; font-weight: bold; }
        .btn-primary:hover { background-color: #e68900; }
        .status-badge { font-size: 0.8em; padding: 5px 10px; border-radius: 12px; }
        .status-new { background: #007bff; color: white; }
        .status-work { background: #ffc107; color: black; }
        .status-done { background: #28a745; color: white; }
        .status-cancel { background: #dc3545; color: white; }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #121212; z-index: 9999; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="card p-5" style="width: 400px; max-width: 90%;">
            <div class="text-center mb-4">
                <h2 class="text-warning"><i class="bi bi-lightning-charge-fill"></i> ProElectro</h2>
                <p class="text-muted">Admin Panel v2.0</p>
            </div>
            <form id="loginForm">
                <div class="mb-3">
                    <input type="password" id="passwordInput" class="form-control form-control-lg bg-dark text-light border-secondary" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å..." required>
                </div>
                <button type="submit" class="btn btn-primary w-100 btn-lg">–í–û–ô–¢–ò</button>
            </form>
        </div>
    </div>

    <div id="dashboard" style="display: none;">
        
        <nav class="navbar navbar-expand-lg navbar-dark mb-4 px-3">
            <a class="navbar-brand text-warning fw-bold" href="#"><i class="bi bi-lightning-charge"></i> ProElectro CRM</a>
            <div class="ms-auto d-flex align-items-center">
                <span class="badge bg-success me-3" id="statusIndicator">‚óè Online</span>
                <button class="btn btn-outline-danger btn-sm" onclick="logout()"><i class="bi bi-box-arrow-right"></i> –í—ã—Ö–æ–¥</button>
            </div>
        </nav>

        <div class="container-fluid px-4">
            
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card p-3">
                        <h6 class="text-muted">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</h6>
                        <h2 id="totalOrders">0</h2>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-3">
                        <h6 class="text-muted">–í —Ä–∞–±–æ—Ç–µ</h6>
                        <h2 id="activeOrders" class="text-warning">0</h2>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-3">
                        <h6 class="text-muted">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</h6>
                        <h2 id="doneOrders" class="text-success">0</h2>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-3">
                        <h6 class="text-muted">–û–±–æ—Ä–æ—Ç (–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª)</h6>
                        <h2 id="totalMoney" class="text-info">0 ‚Ç∏</h2>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-8">
                    <div class="card p-4">
                        <div class="d-flex justify-content-between mb-3">
                            <h4>üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–∫–∞–∑—ã</h4>
                            <button class="btn btn-sm btn-outline-light" onclick="loadStats()"><i class="bi bi-arrow-clockwise"></i></button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-dark table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>–ö–ª–∏–µ–Ω—Ç</th>
                                        <th>–°—É–º–º–∞</th>
                                        <th>–°—Ç–∞—Ç—É—Å</th>
                                        <th>–î–∞—Ç–∞</th>
                                    </tr>
                                </thead>
                                <tbody id="ordersTableBody">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card p-4">
                        <h4>üí∞ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω–∞–º–∏</h4>
                        <p class="text-muted small">–¶–µ–Ω—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤ –±–æ—Ç–µ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ.</p>
                        <form id="settingsForm">
                            <div class="mb-3">
                                <label>üí° –¢–æ—á–∫–∞ (–õ–µ–≥–∫–∏–µ —Å—Ç–µ–Ω—ã)</label>
                                <input type="number" name="wall_light" class="form-control bg-dark text-light border-secondary">
                            </div>
                            <div class="mb-3">
                                <label>üß± –¢–æ—á–∫–∞ (–ö–∏—Ä–ø–∏—á)</label>
                                <input type="number" name="wall_medium" class="form-control bg-dark text-light border-secondary">
                            </div>
                            <div class="mb-3">
                                <label>üèó –¢–æ—á–∫–∞ (–ë–µ—Ç–æ–Ω)</label>
                                <input type="number" name="wall_heavy" class="form-control bg-dark text-light border-secondary">
                            </div>
                            <div class="mb-3">
                                <label>üîå –ú–∞—Ç–µ—Ä–∏–∞–ª (–∑–∞ –º¬≤)</label>
                                <input type="number" name="material_m2" class="form-control bg-dark text-light border-secondary">
                            </div>
                            <button type="submit" class="btn btn-success w-100"><i class="bi bi-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ü–µ–Ω—ã</button>
                        </form>
                    </div>
                    
                    <div class="card p-3 mt-3">
                        <canvas id="ordersChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API = '/api';
        let chartInstance = null;

        // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const res = await fetch(`${API}/me`);
                const data = await res.json();
                if (data.isAdmin) showDashboard();
            } catch (e) { console.log('Auth check failed'); }
        });

        // 2. –õ–æ–≥–∏–Ω
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('passwordInput').value;
            
            try {
                const res = await fetch(`${API}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                
                if (res.ok) {
                    Swal.fire({ icon: 'success', title: '–£—Å–ø–µ—à–Ω–æ!', timer: 1000, showConfirmButton: false });
                    showDashboard();
                } else {
                    Swal.fire({ icon: 'error', title: '–û—à–∏–±–∫–∞', text: '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å' });
                }
            } catch (e) {
                Swal.fire({ icon: 'error', title: '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏' });
            }
        });

        // 3. –í—ã—Ö–æ–¥
        async function logout() {
            await fetch(`${API}/logout`, { method: 'POST' });
            location.reload();
        }

        // 4. –ü–æ–∫–∞–∑–∞—Ç—å –¥–∞—à–±–æ—Ä–¥ –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
        function showDashboard() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            loadStats();
            loadSettings();
        }

        // 5. –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function loadStats() {
            try {
                const res = await fetch(`${API}/stats`);
                const data = await res.json();
                
                // –ö–∞—Ä—Ç–æ—á–∫–∏
                let total = 0, active = 0, done = 0, money = 0;
                data.funnel.forEach(item => {
                    const count = parseInt(item.count);
                    const sum = parseInt(item.money || 0);
                    total += count;
                    if (item.status === 'new' || item.status === 'work') active += count;
                    if (item.status === 'done') done += count;
                    if (item.status !== 'cancel') money += sum;
                });

                document.getElementById('totalOrders').innerText = total;
                document.getElementById('activeOrders').innerText = active;
                document.getElementById('doneOrders').innerText = done;
                document.getElementById('totalMoney').innerText = new Intl.NumberFormat('ru-KZ', { style: 'currency', currency: 'KZT', maximumFractionDigits: 0 }).format(money);

                // –¢–∞–±–ª–∏—Ü–∞
                const tbody = document.getElementById('ordersTableBody');
                tbody.innerHTML = '';
                data.recent.forEach(order => {
                    const statusClass = {
                        'new': 'status-new', 'work': 'status-work', 
                        'done': 'status-done', 'cancel': 'status-cancel'
                    }[order.status] || 'bg-secondary';
                    
                    const row = `<tr>
                        <td>#${order.id}</td>
                        <td>${order.first_name || '–ì–æ—Å—Ç—å'}</td>
                        <td>${Math.round(order.total_work_cost).toLocaleString()} ‚Ç∏</td>
                        <td><span class="status-badge ${statusClass}">${order.status}</span></td>
                        <td>${new Date(order.created_at).toLocaleDateString()}</td>
                    </tr>`;
                    tbody.innerHTML += row;
                });

                // –ì—Ä–∞—Ñ–∏–∫
                renderChart(data.funnel);

            } catch (e) { console.error(e); }
        }

        // 6. –ì—Ä–∞—Ñ–∏–∫ Chart.js
        function renderChart(funnel) {
            const ctx = document.getElementById('ordersChart').getContext('2d');
            const labels = funnel.map(f => f.status);
            const data = funnel.map(f => f.count);

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#007bff', '#ffc107', '#28a745', '#dc3545', '#6c757d'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom', labels: { color: 'white' } } }
                }
            });
        }

        // 7. –ó–∞–≥—Ä—É–∑–∫–∞ —Ü–µ–Ω
        async function loadSettings() {
            const res = await fetch(`${API}/settings`);
            const settings = await res.json();
            const form = document.getElementById('settingsForm');
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É, –µ—Å–ª–∏ —Ü–µ–Ω—ã –µ—Å—Ç—å. –ï—Å–ª–∏ –Ω–µ—Ç - —Å—Ç–∞–≤–∏–º –¥–µ—Ñ–æ–ª—Ç
            form.wall_light.value = settings.wall_light || 4500;
            form.wall_medium.value = settings.wall_medium || 5500;
            form.wall_heavy.value = settings.wall_heavy || 7500;
            form.material_m2.value = settings.material_m2 || 4000;
        }

        // 8. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ü–µ–Ω
        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            try {
                const res = await fetch(`${API}/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    Swal.fire({ icon: 'success', title: '–¶–µ–Ω—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã!', timer: 1500, showConfirmButton: false });
                }
            } catch (e) { Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å', 'error'); }
        });

        // –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫
        setInterval(() => {
            if (document.getElementById('dashboard').style.display === 'block') loadStats();
        }, 30000);

    </script>
</body>
</html>