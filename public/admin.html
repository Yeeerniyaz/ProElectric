<!doctype html>
<html lang="ru" class="antialiased">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="ProElectric Enterprise CRM" />
    <title>ProElectric | CRM</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/feather-icons"></script>
    <link rel="stylesheet" href="css/style.css" />

    <style>
      .cloak {
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }
      .visible {
        opacity: 1;
        pointer-events: auto;
      }
      [hidden] {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <main id="login-screen" class="login-container" role="main">
      <div class="login-box card-elevation">
        <header class="login-header">
          <div class="brand-logo-icon">
            <i data-feather="zap" stroke-width="1.5"></i>
          </div>
          <h1 class="brand-title">ProElectric</h1>
          <p class="text-secondary">Enterprise Control Panel</p>
        </header>

        <form id="login-form" novalidate>
          <div class="form-group">
            <label for="login" class="sr-only">Логин</label>
            <div class="input-wrapper">
              <i data-feather="user" class="input-icon"></i>
              <input
                type="text"
                id="login"
                name="login"
                placeholder="Логин"
                required
                autofocus
                autocomplete="username"
              />
            </div>
          </div>
          <div class="form-group">
            <label for="password" class="sr-only">Пароль</label>
            <div class="input-wrapper">
              <i data-feather="lock" class="input-icon"></i>
              <input
                type="password"
                id="password"
                name="password"
                placeholder="Пароль"
                required
                autocomplete="current-password"
              />
            </div>
          </div>
          <button
            type="submit"
            class="btn primary full"
            data-loading-text="Аутентификация..."
          >
            <span>Войти в систему</span>
            <i data-feather="arrow-right"></i>
          </button>
        </form>
        <div
          id="login-error"
          class="error-msg"
          role="alert"
          aria-live="polite"
        ></div>
      </div>
    </main>

    <div id="app" class="app-container cloak" aria-hidden="true">
      <aside class="sidebar">
        <div class="brand">
          <div class="logo-circle">
            <i data-feather="zap" stroke-width="2"></i>
          </div>
          <div class="brand-text">
            <span class="brand-name">ProElectric</span>
            <span class="brand-desc">Management</span>
          </div>
        </div>

        <nav class="menu" role="navigation">
          <button
            class="menu-item active"
            data-tab="dashboard"
            aria-current="page"
          >
            <i data-feather="grid"></i> <span>Сводка</span>
          </button>
          <button class="menu-item" data-tab="orders">
            <i data-feather="layers"></i> <span>Заказы</span>
          </button>
          <button class="menu-item" data-tab="broadcast">
            <i data-feather="send"></i> <span>Рассылка</span>
          </button>
          <button class="menu-item" data-tab="settings">
            <i data-feather="sliders"></i> <span>Прайс-лист</span>
          </button>
        </nav>

        <div class="sidebar-footer">
          <button id="logout-btn" class="btn-text-danger" data-action="logout">
            <i data-feather="log-out"></i> <span>Завершить сеанс</span>
          </button>
        </div>
      </aside>

      <main class="main-content">
        <header class="top-bar">
          <h2 id="page-title" class="page-title">Сводка данных</h2>
          <div class="user-info">
            <div
              id="loading-indicator"
              class="loader-spinner"
              aria-label="Синхронизация..."
            ></div>
            <div class="user-meta">
              <span class="badge admin">Administrator</span>
              <time id="date-display" class="date-text"></time>
            </div>
          </div>
        </header>

        <section id="tab-dashboard" class="tab-content active" role="tabpanel">
          <div class="kpi-grid">
            <article class="card kpi-card">
              <div class="kpi-icon"><i data-feather="activity"></i></div>
              <div class="kpi-info">
                <h3 class="kpi-label">В работе</h3>
                <p id="kpi-active" class="kpi-value skeleton-box">0</p>
              </div>
            </article>
            <article class="card kpi-card">
              <div class="kpi-icon"><i data-feather="check-circle"></i></div>
              <div class="kpi-info">
                <h3 class="kpi-label">Завершено</h3>
                <p id="kpi-done" class="kpi-value skeleton-box">0</p>
              </div>
            </article>
            <article class="card kpi-card">
              <div class="kpi-icon"><i data-feather="users"></i></div>
              <div class="kpi-info">
                <h3 class="kpi-label">Клиенты</h3>
                <p id="kpi-users" class="kpi-value skeleton-box">0</p>
              </div>
            </article>
            <article class="card kpi-card kpi-highlight">
              <div class="kpi-icon"><i data-feather="trending-up"></i></div>
              <div class="kpi-info">
                <h3 class="kpi-label">Чистая выручка</h3>
                <p id="kpi-revenue" class="kpi-value skeleton-box">0 ₸</p>
              </div>
            </article>
          </div>

          <div class="section-header mt-8">
            <h3 class="section-title">Быстрые действия</h3>
          </div>
          <div class="actions-grid">
            <button
              class="btn primary action-card"
              data-action="open-modal"
              data-target="modal-create-order"
            >
              <i data-feather="plus"></i>
              <span>Создать ручной заказ</span>
            </button>
            <button class="btn secondary action-card" data-action="refresh">
              <i data-feather="refresh-cw"></i>
              <span>Принудительная синхронизация</span>
            </button>
          </div>
        </section>

        <section id="tab-orders" class="tab-content" role="tabpanel" hidden>
          <div class="filters-bar">
            <div class="filters" role="group" aria-label="Фильтр статусов">
              <button class="filter-btn active" data-filter="all">
                Все записи
              </button>
              <button class="filter-btn" data-filter="new">Новые лиды</button>
              <button class="filter-btn" data-filter="processing">
                В обработке
              </button>
              <button class="filter-btn" data-filter="work">На монтаже</button>
              <button class="filter-btn" data-filter="done">Сданы</button>
              <button class="filter-btn" data-filter="cancel">Отказы</button>
            </div>
          </div>

          <div class="card table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th width="5%">ID</th>
                  <th width="20%">Клиент</th>
                  <th width="35%">Объект / Адрес / Заметки</th>
                  <th width="15%">Статус</th>
                  <th width="15%">Сумма работ</th>
                  <th width="10%" class="text-right">Управление</th>
                </tr>
              </thead>
              <tbody id="orders-table-body"></tbody>
            </table>
            <div id="orders-empty" class="empty-state hidden">
              <i data-feather="inbox" class="empty-icon"></i>
              <p>Данные не найдены</p>
            </div>
          </div>
        </section>

        <section id="tab-broadcast" class="tab-content" role="tabpanel" hidden>
          <div class="card max-w-4xl">
            <div class="card-header border-bottom">
              <h3 class="section-title">Панель массовых уведомлений</h3>
              <span class="badge outline">Telegram API</span>
            </div>

            <form id="broadcast-form" class="mt-6">
              <div class="form-group">
                <label>Целевая аудитория</label>
                <select name="targetRole" class="form-control">
                  <option value="all">Все пользователи базы</option>
                  <option value="user">Только клиенты</option>
                </select>
              </div>
              <div class="form-group mt-4">
                <label
                  >Медиа-файл (URL картинки)
                  <span class="text-muted">— Опционально</span></label
                >
                <input
                  type="url"
                  name="imageUrl"
                  class="form-control"
                  placeholder="https://example.com/promo.jpg"
                />
              </div>
              <div class="form-group mt-4">
                <label>Текст сообщения (Поддерживает базовый HTML)</label>
                <textarea
                  name="text"
                  class="form-control"
                  rows="6"
                  placeholder="Внимание, акция! Бесплатный замер..."
                  required
                ></textarea>
              </div>
              <div class="form-actions mt-6">
                <button type="submit" class="btn primary">
                  <i data-feather="send"></i> Запустить рассылку
                </button>
              </div>
            </form>
          </div>
        </section>

        <section id="tab-settings" class="tab-content" role="tabpanel" hidden>
          <div class="card max-w-full">
            <div class="card-header border-bottom">
              <h3 class="section-title">Система ценообразования</h3>
              <span class="badge warning"
                ><i data-feather="save" class="icon-sm"></i> Auto-Save</span
              >
            </div>
            <p class="hint mt-4 mb-6 text-muted">
              Изменения применяются мгновенно. Бот автоматически использует
              новые тарифы для всех расчетов.
            </p>
            <div id="settings-grid" class="settings-grid"></div>
          </div>
        </section>
      </main>
    </div>

    <dialog id="modal-update-details" class="modal-native">
      <form id="update-details-form" method="dialog">
        <div class="modal-header">
          <h3 class="modal-title">
            Данные заказа
            <span id="details-order-id" class="text-primary"></span>
          </h3>
          <button
            type="button"
            class="close-btn"
            data-action="close-modal"
            data-target="modal-update-details"
          >
            <i data-feather="x"></i>
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="details-hidden-id" name="orderId" />
          <div class="form-group">
            <label>Адрес объекта (Студия, Квартира, Дом)</label>
            <input
              type="text"
              id="details-address"
              name="address"
              class="form-control"
              placeholder="г. Алматы, ул. Абая 150, кв 45"
            />
          </div>
          <div class="form-group mt-4">
            <label>Внутренний комментарий (Видит только администрация)</label>
            <textarea
              id="details-comment"
              name="comment"
              class="form-control"
              rows="3"
              placeholder="Сложный клиент, просит скидку..."
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn secondary outline"
            data-action="close-modal"
            data-target="modal-update-details"
          >
            Отмена
          </button>
          <button type="submit" class="btn primary">Сохранить изменения</button>
        </div>
      </form>
    </dialog>

    <dialog id="modal-cancel-order" class="modal-native">
      <form id="cancel-order-form" method="dialog">
        <div class="modal-header">
          <h3 class="modal-title text-danger">Отмена заказа</h3>
          <button
            type="button"
            class="close-btn"
            data-action="close-modal"
            data-target="modal-cancel-order"
          >
            <i data-feather="x"></i>
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="cancel-hidden-id" name="orderId" />
          <p class="mb-4 text-secondary">
            Укажите причину перевода заказа в статус "Отказ" для аналитики:
          </p>
          <div class="form-group">
            <select
              id="cancel-reason-select"
              name="reason"
              class="form-control"
              required
            >
              <option value="" disabled selected>Выберите инициатора...</option>
              <option value="client">Отказ клиента (дорого, передумал)</option>
              <option value="firm">Отказ фирмы (нет мастеров, далеко)</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn secondary outline"
            data-action="close-modal"
            data-target="modal-cancel-order"
          >
            Вернуться
          </button>
          <button type="submit" class="btn danger">Подтвердить отмену</button>
        </div>
      </form>
    </dialog>

    <dialog id="modal-create-order" class="modal-native">
      <form id="create-order-form" method="dialog">
        <div class="modal-header">
          <h3 class="modal-title">Регистрация лида</h3>
          <button
            type="button"
            class="close-btn"
            data-action="close-modal"
            data-target="modal-create-order"
          >
            <i data-feather="x"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-grid two-cols">
            <div class="form-group">
              <label>Имя клиента</label>
              <input
                type="text"
                name="clientName"
                class="form-control"
                placeholder="Иван Иванов"
                required
              />
            </div>
            <div class="form-group">
              <label>Телефон</label>
              <input
                type="tel"
                name="clientPhone"
                class="form-control"
                placeholder="+7 700 000 00 00"
                required
              />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn secondary outline"
            data-action="close-modal"
            data-target="modal-create-order"
          >
            Отмена
          </button>
          <button type="submit" class="btn primary">Создать карточку</button>
        </div>
      </form>
    </dialog>

    <template id="tpl-order-row">
      <tr>
        <td class="font-mono text-sm order-id text-muted"></td>
        <td>
          <div class="client-name font-medium"></div>
          <div class="client-phone text-xs text-muted mt-1"></div>
        </td>
        <td class="order-details-cell">
          <div class="order-address text-sm font-medium"></div>
          <div
            class="order-comment text-xs text-muted mt-1 truncate-text"
          ></div>
          <div class="order-params text-xs text-primary mt-1"></div>
        </td>
        <td><span class="badge status-badge"></span></td>
        <td class="finance-info font-mono font-medium text-lg"></td>
        <td class="actions-cell text-right">
          <div class="btn-group">
            <button
              class="btn-icon outline action-edit"
              title="Детали (Адрес/Коммент)"
            >
              <i data-feather="edit-2"></i>
            </button>
            <button class="btn-icon outline action-cancel" title="Отменить">
              <i data-feather="slash"></i>
            </button>
          </div>
        </td>
      </tr>
    </template>

    <script src="js/api.js"></script>
    <script src="js/app.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => feather.replace());
    </script>
  </body>
</html>
